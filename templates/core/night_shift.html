{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1"><i class="bi bi-moon-stars me-2"></i>Night Shift</h2>
        <p class="text-secondary mb-0">Auto-evolu√ß√£o e melhoria cont√≠nua</p>
    </div>
</div>

<div class="card-dark">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Iniciar An√°lise</h5>
        <button id="start-night-shift" class="btn btn-glow">
            <i class="bi bi-moon-stars me-2"></i>Iniciar Night Shift
        </button>
    </div>
    <div class="card-body">
        <p class="text-secondary mb-4">
            O Night Shift analisa o projeto em busca de melhorias, otimiza√ß√µes e refatora√ß√µes poss√≠veis.
            √â como ter um desenvolvedor s√™nior revisando seu c√≥digo enquanto voc√™ dorme.
        </p>

        <div id="night-shift-results" class="p-4 rounded" style="background: var(--bg-primary); min-height: 200px;">
            <p class="text-center text-secondary">Clique em "Iniciar Night Shift" para come√ßar a an√°lise</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const startBtn = document.getElementById('start-night-shift');
    const results = document.getElementById('night-shift-results');

    startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        startBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analisando...';
        results.innerHTML = '<p class="text-center"><span class="loading-dots">üåô Analisando projeto</span></p>';

        try {
            const response = await fetch('{% url "core:api_night_shift" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.result) {
                results.innerHTML = marked.parse(data.result);
            } else if (data.error) {
                results.innerHTML = `<p class="text-danger">‚ùå Erro: ${data.error}</p>`;
            }
        } catch (error) {
            results.innerHTML = `<p class="text-danger">‚ùå Erro de conex√£o: ${error.message}</p>`;
        }

        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="bi bi-moon-stars me-2"></i>Iniciar Night Shift';
    });
</script>
{% endblock %}